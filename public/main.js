(()=>{"use strict";const n=function(){function n(n,t,e,o){void 0===t&&(t="div"),void 0===e&&(e=""),void 0===o&&(o="");var r=document.createElement(t);r.className=e,r.textContent=o,n&&n.append(r),this.node=r}return n.prototype.destroy=function(){this.node.remove()},n}();var t,e=(t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e])},t(n,e)},function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),o=function(t){function o(e){var o=t.call(this,e)||this,r=(new n(o.node,"div","","x size"),new n(o.node,"input"));r.node.type="number",r.node.min="3",r.node.max="30",r.node.step="1",r.node.value="3",new n(o.node,"div","","y size");var i=new n(o.node,"input");i.node.type="number",i.node.min="3",i.node.max="30",i.node.step="1",i.node.value="3",new n(o.node,"div","","bomb count");var c=new n(o.node,"input");return c.node.type="number",c.node.min="1",c.node.max="30",c.node.step="1",c.node.value="1",new n(o.node,"button","","start game").node.onclick=function(){o.onStartButtonClick({xSize:r.node.valueAsNumber,ySize:i.node.valueAsNumber,bombCount:c.node.valueAsNumber})},o}return e(o,t),o}(n),r=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e])},n(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}(),i=function(n){function t(t,e,o){var r=n.call(this,t,"div","cell")||this;return r.value=e,r.isBomb=o,r.node.textContent="_",r.node.onclick=function(){r.open()},r}return r(t,n),t.prototype.open=function(){var n=this;if(!this.isLocked){if(!this.onOpenStart(this.isBomb))return;return this.animateOpen().then((function(){n.onOpenEnd(n.isBomb)}))}},t.prototype.animateOpen=function(n){var t=this;return this.isLocked?Promise.resolve():(this.lock(),new Promise((function(e,o){t.node.textContent=t.isBomb?"X":t.value?t.value.toString():"",n&&(t.node.style.transitionDuration=n+"ms"),t.node.classList.add("cell__opened"),t.node.ontransitionend=function(n){n.target===t.node&&e()}})))},t.prototype.lock=function(){this.isLocked=!0},t.prototype.unlock=function(){this.isLocked=!1},t}(n),c=function(t){function e(e,o){var r=o.xSize,c=o.ySize,u=o.bombCount,a=t.call(this,e,"div","gamefield")||this;a.cells=[];var s=function(n,t,e){for(var o=[],r=[],i=0;i<t;i++){for(var c=[],u=0;u<n;u++)c.push(!1),r.push({x:u,y:i});o.push(c)}var a=[];for(i=0;i<e;i++){if(!r.length)throw new Error("genaration error");var s=r[r.length-1],l=Math.floor(Math.random()*r.length);r[r.length-1]=r[l],r[l]=s,a.push(r.pop())}return a.forEach((function(n){o[n.y][n.x]=!0})),o}(r,c,u);a.counter=r*c,a.fieldView=new n(a.node,"div","field"),a.isLocked=!1;for(var l=function(t){for(var e=[],o=new n(f.fieldView.node,"div","row"),c=function(n){var r=new i(o.node,function(n,t){for(var e=0,o=-1;o<=1;o++)for(var r=-1;r<=1;r++){var i=o+t.y,c=r+t.x;i>=0&&c>=0&&i<n.length&&c<n[0].length&&(e+=n[i][c]?1:0)}return e}(s,{x:n,y:t}),s[t][n]);r.onOpenStart=function(){if(a.isLocked)return!1;var e=a.checkFigure({x:n,y:t});console.log(e.length,a.counter),e.length>1&&a.animateZeroCells(e).then((function(){a.counter-=e.length-1,a.counter==u?a.finish({isWin:!0}):a.isLocked=!1}));var o=a.isLocked;return a.isLocked=!0,!o},r.onOpenEnd=function(n){n?a.finish({isWin:!1}):(a.counter--,a.counter==u?a.finish({isWin:!0}):a.isLocked=!1)},e.push(r)},l=0;l<r;l++)c(l);f.cells.push(e)},f=this,p=0;p<c;p++)l(p);return new n(a.node,"button","","cancel game").node.onclick=function(){console.log("finish"),a.finish({isWin:!1})},a}return r(e,t),e.prototype.checkFigure=function(n){var t=this;if(console.log(this.cells[n.y][n.x].value),0!==this.cells[n.y][n.x].value)return[];var e=this.cells.map((function(n){return n.map((function(n){return{value:n.value,generation:n.isLocked?-1:Number.MAX_SAFE_INTEGER}}))})),o=[{x:0,y:1},{x:1,y:0},{x:-1,y:0},{x:0,y:-1},{x:1,y:1},{x:1,y:-1},{x:-1,y:1},{x:-1,y:-1}],r=function(n,i,c){var u=[];return n.forEach((function(n){o.forEach((function(o){var r={x:n.x+o.x,y:n.y+o.y};if(r.y>=0&&r.x>=0&&r.y<e.length&&r.x<e[0].length){var a=e[r.y][r.x];a&&a.generation>i&&0==a.value?(u.push(r),a.generation=i,c.push(t.cells[r.y][r.x])):a&&a.generation>i&&0!=a.value&&(a.generation=i,c.push(t.cells[r.y][r.x]))}}))})),u.length?r(u,i+1,c):c};return r([n],0,[])},e.prototype.animateOpenCells=function(){return Promise.all(this.cells.flat().map((function(n,t){return n.animateOpen(1500+600*Math.random())})))},e.prototype.animateZeroCells=function(n){return Promise.all(n.map((function(n,t){return n.animateOpen(1500+600*Math.random())})))},e.prototype.animateClose=function(){var n=this;return new Promise((function(t,e){var o=n.fieldView;o.node.classList.add("field__closed"),o.node.ontransitionend=function(n){n.target===o.node&&t()}}))},e.prototype.finish=function(n){var t=this;this.animateOpenCells().then((function(){})).then((function(){t.onFinish(n)}))},e}(n),u=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e])},n(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}(),a=function(t){function e(e,o){var r=t.call(this,e)||this,i=(new n(r.node,"div","",o.isWin?"win":"lose"),new n(r.node,"button","","to main menu")),c=new n(r.node,"button","","try again");return i.node.onclick=function(){r.onSelect(!1)},c.node.onclick=function(){r.onSelect(!0)},r}return u(e,t),e}(n),s=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e])},n(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}();new(function(n){function t(t){var e=n.call(this,t)||this;return e.startCycle(),e}return s(t,n),t.prototype.startCycle=function(){var n=this,t=new o(this.node);t.onStartButtonClick=function(e){t.destroy(),n.gameCycle(e)}},t.prototype.gameCycle=function(n){var t=this,e=new c(this.node,n);e.onFinish=function(o){e.destroy();var r=new a(t.node,o);r.onSelect=function(e){r.destroy(),1==e?t.gameCycle(n):t.startCycle()}}},t}(n))(document.body)})();